<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FinBuddy Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f4f6f8;
      font-family: 'Segoe UI', sans-serif;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }
    .chart-container {
      position: relative;
      height: 400px;
    }
    .btn-group .btn.active {
      background-color: #0d6efd;
      color: white;
    }
    .protimeter {
      font-weight: bold;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      color: white;
    }
    .small-chart {
      height: 200px;
    }
  </style>
</head>
<body>
<div class="container py-4">
  <h2 class="mb-4 text-center">ðŸ“ˆ FinBuddy - Stock Analyzer</h2>

  <!-- Company Selector -->
  <div class="mb-3">
    <label for="companySelect" class="form-label">Select a Company</label>
    <select class="form-select" id="companySelect">
      <option value="" disabled selected>Select a company</option>
    </select>
  </div>

  <!-- Graph Card -->
  <div class="card p-4">
    <div class="d-flex justify-content-between align-items-center">
      <h5>Stock Price Chart</h5>
      <div class="btn-group" role="group">
        <button class="btn btn-outline-primary time-btn" data-range="1d">1D</button>
        <button class="btn btn-outline-primary time-btn" data-range="1w">1W</button>
        <button class="btn btn-outline-primary time-btn" data-range="1m">1M</button>
        <button class="btn btn-outline-primary time-btn" data-range="1y">1Y</button>
        <button class="btn btn-outline-primary time-btn" data-range="2y">2Y</button>
      </div>
    </div>
    <div class="chart-container mt-3">
      <canvas id="stockChart"></canvas>
    </div>
  </div>

  <!-- MA Chart -->
  <div class="card p-4">
    <h5>MA20 vs MA30</h5>
    <div class="chart-container small-chart">
      <canvas id="maChart"></canvas>
    </div>
  </div>

  <!-- Financial Data -->
  <div class="card p-4">
    <h5>Financial Overview</h5>
    <div class="btn-group mb-2">
      <button class="btn btn-outline-success finance-btn" data-type="annual">Annual</button>
      <button class="btn btn-outline-success finance-btn" data-type="quarterly">Quarterly</button>
    </div>
    <canvas id="financeChart"></canvas>
  </div>

  <!-- RSI/MACD/Volume Table -->
  <div class="card p-4">
    <h5>Technical Indicators</h5>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>RSI</th>
          <th>MACD</th>
          <th>Signal Line</th>
          <th>Volume</th>
        </tr>
      </thead>
      <tbody id="indicatorsTable"></tbody>
    </table>
  </div>

  <!-- Protimeter -->
  <div class="card">
    <div id="protimeter" class="protimeter bg-secondary">Loading sentiment...</div>
  </div>
</div>

<script>
const stockChartCtx = document.getElementById('stockChart').getContext('2d');
const financeChartCtx = document.getElementById('financeChart').getContext('2d');
const maChartCtx = document.getElementById('maChart').getContext('2d');
let stockChart, financeChart, maChart;

const renderChart = (labels, data) => {
  if (stockChart) stockChart.destroy();
  stockChart = new Chart(stockChartCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Close Price',
        data,
        borderColor: 'blue',
        tension: 0.3,
        fill: false
      }]
    }
  });
};

const renderMAChart = (labels, ma20, ma30) => {
  if (maChart) maChart.destroy();
  maChart = new Chart(maChartCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'MA 20', data: ma20, borderColor: 'green', borderWidth: 2, fill: false },
        { label: 'MA 30', data: ma30, borderColor: 'red', borderWidth: 2, fill: false }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } }
    }
  });
};

const renderFinance = (labels, revenue, profit) => {
  if (financeChart) financeChart.destroy();
  financeChart = new Chart(financeChartCtx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Revenue', data: revenue, backgroundColor: 'green' },
        { label: 'Net Profit', data: profit, backgroundColor: 'orange' }
      ]
    },
    options: { responsive: true }
  });
};

const fetchData = (symbol, range = '1m', financeType = 'annual') => {
  if (!symbol) {
    alert("Please select a valid company");
    return;
  }

  fetch('/api/data', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ symbol, range, finance: financeType })
  })
  .then(res => {
    if (!res.ok) throw new Error("Network response was not ok");
    return res.json();
  })
  .then(data => {
    console.log("âœ… Received data:", data);

    if (data.graph && data.graph.dates && data.graph.close) {
      renderChart(data.graph.dates, data.graph.close);
    }

    if (data.graph && data.graph.ma20 && data.graph.ma30) {
      renderMAChart(data.graph.dates, data.graph.ma20, data.graph.ma30);
    }

    if (data.financial && data.financial.labels && data.financial.revenue && data.financial.profit) {
      renderFinance(data.financial.labels, data.financial.revenue, data.financial.profit);
    }

    if (data.indicators) {
      const { RSI = '-', MACD = '-', Signal = '-', Volume = '-' } = data.indicators;
      document.getElementById('indicatorsTable').innerHTML = `
        <tr>
          <td>${RSI}</td>
          <td>${MACD}</td>
          <td>${Signal}</td>
          <td>${Volume}</td>
        </tr>
      `;
    }

    const meter = document.getElementById('protimeter');
    if (data.protimeter) {
      const sentiment = data.protimeter.toLowerCase();
      meter.textContent = `Sentiment: ${data.protimeter}`;
      meter.className = `protimeter bg-${sentiment === 'bullish' ? 'success' : sentiment === 'bearish' ? 'danger' : 'warning'}`;
    } else {
      meter.textContent = 'Sentiment: N/A';
      meter.className = 'protimeter bg-secondary';
    }
  })
  .catch(error => {
    console.error('âŒ Error fetching data:', error);
    alert("Unable to fetch data. Please try again later.");
  });
};

fetch('/api/companies')
  .then(res => res.json())
  .then(companies => {
    const select = document.getElementById('companySelect');
    companies.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.symbol;
      opt.textContent = `${c.name} (${c.symbol})`;
      select.appendChild(opt);
    });
  });

document.getElementById('companySelect').addEventListener('change', e => {
  const symbol = e.target.value;
  fetchData(symbol);
});

document.querySelectorAll('.time-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const range = btn.getAttribute('data-range');
    const symbol = document.getElementById('companySelect').value;
    if (symbol) fetchData(symbol, range);
  });
});

document.querySelectorAll('.finance-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.finance-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const financeType = btn.getAttribute('data-type');
    const symbol = document.getElementById('companySelect').value;
    if (symbol) fetchData(symbol, undefined, financeType);
  });
});
</script>
</body>
</html>
