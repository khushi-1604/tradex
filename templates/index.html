<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FinBuddy Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f4f6f8;
      font-family: 'Segoe UI', sans-serif;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }
    .chart-container {
      position: relative;
      height: 400px;
    }
    .btn-group .btn.active {
      background-color: #0d6efd;
      color: white;
    }
    .protimeter {
      font-weight: bold;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      color: white;
    }
  </style>
  <script>
let stockData = [];

document.getElementById("csvFile").addEventListener("change", function (e) {
  const reader = new FileReader();
  reader.onload = function () {
    const lines = reader.result.trim().split("\n");

    const header = lines[0].toLowerCase();
    const hasHeader = header.includes("date") && header.includes("close");
    const dataLines = hasHeader ? lines.slice(1) : lines;

    stockData = dataLines
      .map((row) => {
        const cols = row.split(",");
        if (cols.length < 5) return null;

        const date = new Date(cols[0].trim());
        const close = parseFloat(cols[4]);

        if (isNaN(close) || isNaN(date.getTime())) return null;

        return { date, close };
      })
      .filter((d) => d !== null)
      .sort((a, b) => a.date - b.date);

    if (stockData.length === 0) {
      alert("Error: No valid data found in CSV. Ensure it includes 'Date' and 'Close' columns.");
      return;
    }

    alert("CSV loaded!");
  };
  reader.readAsText(e.target.files[0]);
});

function movingAverage(data, period, idx) {
  if (idx < period - 1) return null;
  let sum = 0;
  for (let i = idx - period + 1; i <= idx; i++) {
    sum += data[i].close;
  }
  return sum / period;
}

let chart;
function runSimulation() {
  const start = new Date(document.getElementById("startDate").value);
  const end = new Date(document.getElementById("endDate").value);

  const filtered = stockData.filter((d) => d.date >= start && d.date <= end);
  if (filtered.length < 30) return alert("Not enough data in range");

  let log = [];
  let principal = 100000;
  let holding = false,
    qty = 0,
    buyPrice = 0;

  let labels = [],
    prices = [],
    ma20 = [],
    ma30 = [],
    buys = [],
    sells = [];

  for (let i = 0; i < filtered.length; i++) {
    const d = filtered[i];
    const dateStr = d.date.toISOString().split("T")[0];

    const m20 = movingAverage(filtered, 20, i);
    const m30 = movingAverage(filtered, 30, i);

    labels.push(dateStr);
    prices.push(d.close);
    ma20.push(m20);
    ma30.push(m30);

    if (!m20 || !m30) continue;

    if (!holding && m20 > m30) {
      qty = Math.floor(principal / d.close);
      buyPrice = d.close;
      const invest = qty * d.close;
      principal -= invest;
      holding = true;
      buys.push({ x: dateStr, y: d.close });

      log.push({
        date: dateStr,
        action: "BUY",
        price: d.close.toFixed(2),
        qty,
        invest: invest.toFixed(2),
        gainLoss: "-",
        principal: principal.toFixed(2),
      });
    }

    if (holding && m20 < m30) {
      const sell = qty * d.close;
      const gainLoss = sell - qty * buyPrice;
      principal += sell;
      sells.push({ x: dateStr, y: d.close });

      log.push({
        date: dateStr,
        action: "SELL",
        price: d.close.toFixed(2),
        qty,
        invest: (qty * buyPrice).toFixed(2),
        gainLoss: gainLoss.toFixed(2),
        principal: principal.toFixed(2),
      });
      holding = false;
      qty = 0;
    }
  }

  if (holding) {
    const last = filtered[filtered.length - 1];
    const sell = qty * last.close;
    const gainLoss = sell - qty * buyPrice;
    principal += sell;
    sells.push({ x: labels[labels.length - 1], y: last.close });

    log.push({
      date: labels[labels.length - 1],
      action: "SELL",
      price: last.close.toFixed(2),
      qty,
      invest: (qty * buyPrice).toFixed(2),
      gainLoss: gainLoss.toFixed(2),
      principal: principal.toFixed(2),
    });
  }

  renderLog(log);
  renderChart(labels, prices, ma20, ma30, buys, sells);
}

function renderLog(log) {
  const tbody = document.querySelector("#transactionTable tbody");
  tbody.innerHTML = "";
  log.forEach((row) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.date}</td>
      <td>${row.action}</td>
      <td>${row.price}</td>
      <td>${row.qty}</td>
      <td>${row.invest}</td>
      <td>${row.gainLoss}</td>
      <td>${row.principal}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderChart(labels, prices, ma20, ma30, buys, sells) {
  const ctx = document.getElementById("priceChart").getContext("2d");
  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Close Price",
          data: prices,
          borderColor: "blue",
          fill: false,
        },
        {
          label: "MA20",
          data: ma20,
          borderColor: "green",
          fill: false,
        },
        {
          label: "MA30",
          data: ma30,
          borderColor: "red",
          fill: false,
        },
        {
          label: "Buy",
          data: buys,
          type: "scatter",
          backgroundColor: "green",
          pointRadius: 5,
        },
        {
          label: "Sell",
          data: sells,
          type: "scatter",
          backgroundColor: "red",
          pointRadius: 5,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: { legend: { position: "top" } },
      scales: {
        x: { ticks: { maxTicksLimit: 20, autoSkip: true } },
      },
    },
  });
}
</script>

</head>
<body>
<div class="container py-4">
  <h2 class="mb-4 text-center">üìà FinBuddy - Stock Analyzer</h2>

  <!-- Company Selector -->
  <div class="mb-3">
    <label for="companySelect" class="form-label">Select a Company</label>
    <select class="form-select" id="companySelect">
      <option value="" disabled selected>Select a company</option>
    </select>
  </div>

  <!-- Graph Card -->
  <div class="card p-4">
    <div class="d-flex justify-content-between align-items-center">
      <h5>Stock Price Chart</h5>
      <div class="btn-group" role="group">
        <button class="btn btn-outline-primary time-btn" data-range="1d">1D</button>
        <button class="btn btn-outline-primary time-btn" data-range="1m">1M</button>
        <button class="btn btn-outline-primary time-btn" data-range="1w">6M</button>
        <button class="btn btn-outline-primary time-btn" data-range="1y">1Y</button>
        <button class="btn btn-outline-primary time-btn" data-range="2y">2Y</button>
      </div>
    </div>
    <div class="chart-container mt-3">
      <canvas id="stockChart"></canvas>
    </div>
  </div>

  <!-- Financial Data -->
  <div class="card p-4">
    <h5>Financial Overview</h5>
    <div class="btn-group mb-2">
      <button class="btn btn-outline-success finance-btn" data-type="annual">Annual</button>
      <button class="btn btn-outline-success finance-btn" data-type="quarterly">Quarterly</button>
    </div>
    <canvas id="financeChart"></canvas>
  </div>

  <!-- RSI/MACD/Volume Table -->
  <div class="card p-4">
    <h5>Technical Indicators</h5>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>RSI</th>
          <th>MACD</th>
          <th>Signal Line</th>
          <th>Volume</th>
        </tr>
      </thead>
      <tbody id="indicatorsTable"></tbody>
    </table>
  </div>

  <!-- Protimeter -->
  <div class="card">
    <div id="protimeter" class="protimeter bg-secondary">Loading sentiment...</div>
  </div>
</div>

<!-- <script>
const stockChartCtx = document.getElementById('stockChart').getContext('2d');
const financeChartCtx = document.getElementById('financeChart').getContext('2d');
let stockChart, financeChart;

const renderChart = (labels, data) => {
  if (stockChart) stockChart.destroy();
  stockChart = new Chart(stockChartCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Close Price',
        data,
        borderColor: 'blue',
        tension: 0.3,
        fill: false
      }]
    }
  });
};

const renderFinance = (labels, revenue, profit) => {
  if (financeChart) financeChart.destroy();
  financeChart = new Chart(financeChartCtx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Revenue', data: revenue, backgroundColor: 'green' },
        { label: 'Net Profit', data: profit, backgroundColor: 'orange' }
      ]
    },
    options: { responsive: true }
  });
};

const fetchData = (symbol, range = '1m', financeType = 'annual') => {
  if (!symbol) {
    alert("Please select a valid company");
    return;
  }

  fetch('/api/data', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ symbol, range, finance: financeType })
  })
  .then(res => {
    if (!res.ok) throw new Error("Network response was not ok");
    return res.json();
  })
  .then(data => {
    console.log("‚úÖ Received data:", data);

    if (data.graph && data.graph.dates && data.graph.close) {
      renderChart(data.graph.dates, data.graph.close);
    } else {
      console.warn("‚ö†Ô∏è Missing graph data");
    }

    if (data.financial && data.financial.labels && data.financial.revenue && data.financial.profit) {
      renderFinance(data.financial.labels, data.financial.revenue, data.financial.profit);
    } else {
      console.warn("‚ö†Ô∏è Missing financial data");
    }

    if (data.indicators) {
      const { RSI = '-', MACD = '-', Signal = '-', Volume = '-' } = data.indicators;
      document.getElementById('indicatorsTable').innerHTML = `
        <tr>
          <td>${RSI}</td>
          <td>${MACD}</td>
          <td>${Signal}</td>
          <td>${Volume}</td>
        </tr>
      `;
    } else {
      console.warn("‚ö†Ô∏è Missing indicators");
    }

    const meter = document.getElementById('protimeter');
    if (data.protimeter) {
      const sentiment = data.protimeter.toLowerCase();
      meter.textContent = `Sentiment: ${data.protimeter}`;
      meter.className = `protimeter bg-${sentiment === 'bullish' ? 'success' : sentiment === 'bearish' ? 'danger' : 'warning'}`;
    } else {
      meter.textContent = 'Sentiment: N/A';
      meter.className = 'protimeter bg-secondary';
    }
  })
  .catch(error => {
    console.error('‚ùå Error fetching data:', error);
    alert("Unable to fetch data. Please try again later.");
  });
};

fetch('/api/companies')
  .then(res => res.json())
  .then(companies => {
    const select = document.getElementById('companySelect');
    companies.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.symbol;
      opt.textContent = `${c.name} (${c.symbol})`;
      select.appendChild(opt);
    });
  });

document.getElementById('companySelect').addEventListener('change', e => {
  const symbol = e.target.value;
  fetchData(symbol);
});

document.querySelectorAll('.time-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const range = btn.getAttribute('data-range');
    const symbol = document.getElementById('companySelect').value;
    if (symbol) fetchData(symbol, range);
  });
});

document.querySelectorAll('.finance-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.finance-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const financeType = btn.getAttribute('data-type');
    const symbol = document.getElementById('companySelect').value;
    if (symbol) fetchData(symbol, undefined, financeType);
  });
});
</script> -->


<script>
const stockChartCtx = document.getElementById('stockChart').getContext('2d');
const financeChartCtx = document.getElementById('financeChart').getContext('2d');
let stockChart, financeChart;
let selectedMARange = [20, 30]; // Default

const renderChart = (labels, close, ma1, ma2, maLabels) => {
  if (stockChart) stockChart.destroy();
  stockChart = new Chart(stockChartCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Close Price',
          data: close,
          borderColor: 'blue',
          tension: 0.3,
          fill: false
        },
        {
          label: maLabels[0],
          data: ma1,
          borderColor: 'green',
          borderDash: [5, 5],
          tension: 0.3,
          fill: false
        },
        {
          label: maLabels[1],
          data: ma2,
          borderColor: 'red',
          borderDash: [5, 5],
          tension: 0.3,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top'
        }
      }
    }
  });
};

const renderFinance = (labels, revenue, profit) => {
  if (financeChart) financeChart.destroy();
  financeChart = new Chart(financeChartCtx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Revenue', data: revenue, backgroundColor: 'green' },
        { label: 'Net Profit', data: profit, backgroundColor: 'orange' }
      ]
    },
    options: { responsive: true }
  });
};

const fetchData = (symbol, range = '1m', financeType = 'annual') => {
  if (!symbol) {
    alert("Please select a valid company");
    return;
  }

  fetch('/api/data', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      symbol,
      range,
      finance: financeType,
      maRange: selectedMARange
    })
  })
  .then(res => {
    if (!res.ok) throw new Error("Network response was not ok");
    return res.json();
  })
  .then(data => {
    if (data.graph && data.graph.dates && data.graph.close) {
      renderChart(
        data.graph.dates,
        data.graph.close,
        data.graph[`ma${selectedMARange[0]}`],
        data.graph[`ma${selectedMARange[1]}`],
        data.maLabels
      );
    }

    if (data.financial && data.financial.labels && data.financial.revenue && data.financial.profit) {
      renderFinance(data.financial.labels, data.financial.revenue, data.financial.profit);
    }

    if (data.indicators) {
      const { RSI = '-', MACD = '-', Signal = '-', Volume = '-' } = data.indicators;
      document.getElementById('indicatorsTable').innerHTML = `
        <tr>
          <td>${RSI}</td>
          <td>${MACD}</td>
          <td>${Signal}</td>
          <td>${Volume}</td>
        </tr>
      `;
    }

    const meter = document.getElementById('protimeter');
    if (data.protimeter) {
      const sentiment = data.protimeter.toLowerCase();
      meter.textContent = `Sentiment: ${data.protimeter}`;
      meter.className = `protimeter bg-${sentiment === 'bullish' ? 'success' : sentiment === 'bearish' ? 'danger' : 'warning'}`;
    } else {
      meter.textContent = 'Sentiment: N/A';
      meter.className = 'protimeter bg-secondary';
    }
  })
  .catch(error => {
    console.error('‚ùå Error fetching data:', error);
    alert("Unable to fetch data. Please try again later.");
  });
};

fetch('/api/companies')
  .then(res => res.json())
  .then(companies => {
    const select = document.getElementById('companySelect');
    companies.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.symbol;
      opt.textContent = `${c.name} (${c.symbol})`;
      select.appendChild(opt);
    });
  });

document.getElementById('companySelect').addEventListener('change', e => {
  const symbol = e.target.value;
  fetchData(symbol);
});

document.querySelectorAll('.time-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const range = btn.getAttribute('data-range');
    const symbol = document.getElementById('companySelect').value;
    if (symbol) fetchData(symbol, range);
  });
});

document.querySelectorAll('.finance-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.finance-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const financeType = btn.getAttribute('data-type');
    const symbol = document.getElementById('companySelect').value;
    if (symbol) fetchData(symbol, undefined, financeType);
  });
});

// Moving Average Range Filter
const maDropdown = document.createElement('select');
maDropdown.className = 'form-select w-auto ms-3';
['20-30', '30-40', '40-50'].forEach(opt => {
  const o = document.createElement('option');
  o.value = opt;
  o.textContent = `MA ${opt}`;
  maDropdown.appendChild(o);
});
document.querySelector('.card h5').appendChild(maDropdown);

maDropdown.addEventListener('change', () => {
  const [low, high] = maDropdown.value.split('-').map(Number);
  selectedMARange = [low, high];
  const symbol = document.getElementById('companySelect').value;
  if (symbol) fetchData(symbol);
});
</script>

</body>
</html>


